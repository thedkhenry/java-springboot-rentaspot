<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <style>
        /* Always set the map height explicitly to define the size of the div
             * element that contains the map. */
        #googlemap {
            min-height: 100vh;
            max-height: 100vh;
            max-width: 100%;
        }
        @media (max-width: 1200px) {
            .list-col {
                max-width: 100% !important;
            }
            .map-col {
                display: none;
            }
        }
        @media (max-width: 576px) {
            header {
                position: static !important;
            }
        }
    </style>
</head>

<body>
    <header class="sticky-top shadow bg-white pb-2">
        <div th:replace="fragments/general.html :: navbar"></div>
        <div class="container">
            <form th:action="@{/search}" method="GET" id="searchForm">
                <div class="row justify-content-center my-3">
                    <div class="col-7 col-sm-3 form-floating px-0">
                        <input name="city" type="text" class="form-control">
                        <label>City</label>
                    </div>
                    <div class="col-7 col-sm-3 form-floating px-0">
                        <input th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" name="startDate" type="date" class="form-control">
                        <label>Check in</label>
                    </div>
                    <div class="col-7 col-sm-3 form-floating px-0">
                        <input th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" name="endDate" type="date" class="form-control">
                        <label>Check out</label>
                    </div>
                    <div class="col-7 col-sm-3 form-floating px-0">
                        <input name="cars" type="number" class="form-control" min="0" value="0">
                        <label>Cars</label>
                    </div>
                    <div class="col-12 text-center pt-3">
                        <button type="submit" form="searchForm" class="btn btn-danger">Search</button>
                    </div>
                </div>
            </form>
        </div>
    </header>
    <div class="row w-100 m-0">
        <div class="list-col col p-0" style="max-width: 840px;">
            <h6 th:if="${#lists.isEmpty(locations)}" class="text-center text-muted mt-3">That's embarrassing... No listings found.<br/>Please try another search.</h6>
            <th:block th:unless="${#lists.isEmpty(locations)}">
                <ul class="list-group">
                    <th:block th:each="loc : ${locations}">
                        <li class="list-group-item list-group-item-action py-3">
                            <div class="row">
                                <div class="col-sm-3">
                                    <a th:href="@{/location/{locationId}(locationId = ${loc.id})}"
                                       class="stretched-link"><img
                                            th:src="@{/images/city_buildings.png}" class="img-fluid" alt="..."></a>
                                </div>
                                <div class="col-sm-9">
                                    <div class="col h-75">
                                        <div th:text="${loc.title}" class="fw-bold text-truncate"></div>
                                        <div th:text="${loc.totalOccupancy} + ' Cars • '+${loc.address.city}+', '+${loc.address.state}+''"
                                             class="text-muted"></div>
                                        <p th:text="${loc.description}" class="d-none d-sm-block"></p>
                                    </div>
                                    <div class="row w-100">
                                        <div th:text="'⭐ ' + ${loc.calculateWeightedAverage()} + ' (' + ${loc.reviews.size()} + ' Reviews)'"
                                             class="col-9 text-muted"></div>
                                        <div th:text="'$' + ${loc.price} + '/day'"
                                             class="col-3 text-end fw-bold"></div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </th:block>
                </ul>
            </th:block>
        </div>
        <div class="map-col col p-0">
            <div class="w-100 position-fixed ">
                <div class="">
                    <div id="googlemap"></div>
                </div>
            </div>
        </div>
    </div>
<!--    <script>-->
<!--        var dbMarkers = ${xxx};-->
<!--    </script>-->
<!--    <script src="/js/map.js"></script>-->
<!--    <script  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdWXRP5I-hsLgC4k4-VUWjdr6s5mw9Img&callback=initMap"></script>-->
    <script th:inline="javascript">
        var resultLocations = [[${addresses}]];
        var city = [[${city}]];
        var map;
        var infoWindow;
        var geocoder;
        function initMap() {
            infoWindow = new google.maps.InfoWindow;
            geocoder = new google.maps.Geocoder();
            map = new google.maps.Map(document.getElementById('googlemap'), {
                center: { lat: 33.50393571438486, lng: -112.04478456037113 },
                zoom: 8
            });
            // geocoder.geocode({'address': city}, function(results, status) {
            //     if (status === 'OK') {
            //         map.setCenter(results[0].geometry.location);
            //     } else {
            //         alert('Geocode was not successful for the following reason: ' + status);
            //     }
            // });
            addMapMarkers(resultLocations);
        }

        function addMapMarkers(addresses){
            console.log("addresses.length " + addresses.length);
            for(let i=0; i<addresses.length; i++){
                console.log("id: " + addresses[i].id + " lat: " + addresses[i].latitude + " lng: " + addresses[i].longitude);
                var spotDetails =
                    '<div class="infoWindow">'+
                    '      <p>'+ addresses[i].address1 + '</p>'+
                    '      <div class="viewGMaps"><a target="_blank" href="https://www.google.com/maps/search/?api=1&query='+ addresses[i].latitude + ','+ addresses[i].longitude + '"' +'>View on Google Maps</a></div>'+
                    '    </div>';

                var marker = new google.maps.Marker({
                    id: addresses[i].id,
                    map: map,
                    position: {lat: addresses[i].latitude, lng: addresses[i].longitude},
                    info: spotDetails
                });

                // markers.push(marker);

                google.maps.event.addListener(marker, 'click', function() {
                    var markerId = this.id;
                    infoWindow.setContent(this.info);
                    infoWindow.open(map,this);
                    console.log("id: " + this.id + " SpotPos: ")
                    console.log(this.position.toJSON());
                });
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyCd8To3zMx7ydSQc8vsZe2cAr7V3fnFo&callback=initMap" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
    crossorigin="anonymous"></script>
</body>

</html>